#!/bin/bash

# This script has been generated automatically on the base of wviola.yml config file.
# DO NOT EDIT directly, unless you know what you are doing.
#
# To regenerate the scripts, run the task
#     symfony wviola:generate-scripts
#
# See
#     symfony help wviola:generate-scripts
#  
# for details

if [[ $# -lt 1 ]]; then
	echo $0 source
	exit 1
fi

UNIQID="$1"
ARTIST="$2"
TITLE="$3"
DATE="$4"
LOCATION="$5"
ORGANIZATION="$6"
COPYRIGHT="$7"
LICENSE="$8"
CONTACT="$9"
# these items come from the documentation of ffmpeg2theora

IFS=$'\n'

TEMPDIR=$(mktemp -d)

unzip "/var/wviola/data/filesystem/scheduled/$UNIQID" -d $TEMPDIR || exit 2
cd $TEMPDIR
mkdir low high
for IMAGE in $(find . -maxdepth 1  -type f); do
  convert "$IMAGE" -scale 640x480 -quality 75 "low/$IMAGE" || exit 3
  convert "$IMAGE" -scale 800x600 -quality 90 "high/$IMAGE" || exit 4
done
zip "/tmp/littledir/$UNIQID.zip" -j low/* || exit 5
zip "/var/wviola/data/filesystem/iso_images/cache/$UNIQID.zip" -j high/* || exit 6
mv -v "/var/wviola/data/filesystem/scheduled/$UNIQID" "/var/wviola/data/filesystem/trash" || exit 7


echo 'PUBLISHED'

cd; rm -rf $TEMPDIR

